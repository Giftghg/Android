# 图片上传功能使用说明

## 问题解决

### 1. 问题描述
- Android端发布商品时，图片的`image_url`字段保存的是`content://`开头的本地content URI
- 商品详情页、商品列表页等页面无法正常显示用户上传的图片
- 只有网络图片（如`https://example.com/iphone12.jpg`）能正常显示

### 2. 解决方案
- 将图片文件上传到Flask后端服务器
- 服务器返回可公网访问的图片URL（如`http://10.0.2.2:5000/uploads/xxx.jpg`）
- 数据库`image_url`字段保存网络URL，而不是`content://...`

## 修改内容

### 1. Android端修改

#### 新增文件：`UploadUtil.java`
- 位置：`app/src/main/java/com/example/myapplication/util/UploadUtil.java`
- 功能：图片上传工具类，使用multipart/form-data方式上传图片到服务器

#### 修改文件：`PublishFragment.java`
- 位置：`app/src/main/java/com/example/myapplication/fragment/PublishFragment.java`
- 修改内容：
  - 添加`UploadUtil`导入
  - 修改`publishProduct()`方法，先上传图片再发布商品
  - 新增`uploadImageAndPublish()`、`publishProductWithImage()`、`publishProductWithoutImage()`方法

#### 修改文件：`ApiClient.java`
- 位置：`app/src/main/java/com/example/myapplication/util/ApiClient.java`
- 修改内容：将BASE_URL从`http://10.34.68.221:5000/api`改为`http://10.0.2.2:5000/api`

### 2. Flask后端修改

#### 修改文件：`app.py`
- 位置：`backend/app.py`
- 新增内容：
  - 图片上传配置（UPLOAD_FOLDER、ALLOWED_EXTENSIONS）
  - `allowed_file()`函数：检查文件扩展名
  - `/api/upload_image`接口：处理图片上传
  - `/uploads/<filename>`接口：提供图片文件访问

#### 新增文件：`start_flask.py`
- 位置：`backend/start_flask.py`
- 功能：Flask启动脚本，确保正确监听所有网络接口

#### 新增文件：`test_upload.py`
- 位置：`backend/test_upload.py`
- 功能：测试图片上传功能

## 使用步骤

### 1. 启动Flask后端
```bash
cd backend
python start_flask.py
```

### 2. 测试图片上传功能（可选）
```bash
cd backend
python test_upload.py
```

### 3. 在Android Studio中运行应用
- 确保Android模拟器已启动
- 运行Android应用
- 发布商品时选择图片，系统会自动先上传图片再发布商品

## 网络配置说明

### Android模拟器访问宿主机
- Android模拟器使用`10.0.2.2`访问宿主机（你的电脑）
- 这是Android模拟器的特殊IP地址，相当于`localhost`或`127.0.0.1`

### Flask后端监听配置
- Flask使用`host='0.0.0.0'`监听所有网络接口
- 端口：5000
- 这样Android模拟器就能访问到Flask后端

## 功能流程

### 发布商品流程
1. 用户选择图片
2. 点击发布商品
3. 系统先调用`UploadUtil.uploadImage()`上传图片到Flask后端
4. Flask后端保存图片到`uploads/`目录，返回图片URL
5. 系统使用返回的图片URL调用`ApiClient.createProduct()`发布商品
6. 数据库中保存的是网络图片URL，所有用户都能访问

### 图片访问流程
1. 商品列表/详情页显示图片时，直接使用`image_url`字段
2. `image_url`是网络地址，如`http://10.0.2.2:5000/uploads/xxx.jpg`
3. Android的ImageView可以直接加载网络图片

## 注意事项

1. **网络连接**：确保Android模拟器和电脑在同一网络环境
2. **Flask启动**：必须使用`host='0.0.0.0'`启动Flask
3. **图片格式**：支持jpg、jpeg、png、gif格式
4. **文件大小**：建议图片大小不超过5MB
5. **权限**：Android端已配置网络和存储权限

## 测试验证

1. 启动Flask后端后，访问`http://localhost:5000/api/products`确认API正常
2. 在Android应用中发布带图片的商品
3. 查看数据库中`image_url`字段是否为网络地址
4. 在商品列表和详情页确认图片能正常显示

## 故障排除

### 网络连接超时
- 检查Flask是否使用`host='0.0.0.0'`启动
- 确认防火墙没有阻止5000端口
- 检查Android模拟器网络设置

### 图片上传失败
- 检查Flask后端的`uploads/`目录是否存在
- 确认图片格式是否支持
- 查看Flask后端日志获取详细错误信息

### 图片无法显示
- 确认`image_url`字段是网络地址而不是content URI
- 检查图片URL是否能在浏览器中访问
- 确认Android网络权限已配置 